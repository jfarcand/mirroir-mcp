#!/bin/bash
# ABOUTME: Pre-commit hook for Swift code quality enforcement
# ABOUTME: Checks ABOUTME headers, suspicious files, and swift build

set -e

# Check that Swift source files have ABOUTME headers
check_aboutme_headers() {
    local missing_headers=""

    # Get staged Swift files (added or modified)
    local swift_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.swift$' | grep -v '/Tests/' | grep -v 'Package.swift' || true)

    for file in $swift_files; do
        if [ -f "$file" ]; then
            # Check first 5 lines for ABOUTME pattern
            if ! head -5 "$file" | grep -q "ABOUTME:"; then
                missing_headers="$missing_headers\n  - $file"
            fi
        fi
    done

    if [ -n "$missing_headers" ]; then
        echo "ERROR: Commit blocked - Missing ABOUTME headers:"
        echo -e "$missing_headers"
        echo ""
        echo "All Swift source files must start with a 2-line ABOUTME comment. Format:"
        echo "  // ABOUTME: Brief description of what this file does."
        echo "  // ABOUTME: Additional context about the file's purpose."
        return 1
    fi
    return 0
}

# Check for files with suspicious patterns (backups, old files, etc.)
check_suspicious_files() {
    local suspicious_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(bak|orig|tmp|swp)$|_old\.|old_|\.old\.' || true)

    if [ -n "$suspicious_files" ]; then
        echo "ERROR: Commit blocked - Found suspicious files:"
        echo "$suspicious_files" | sed 's/^/  - /'
        echo ""
        echo "These files appear to be backups or old versions."
        echo "Please remove them or rename them before committing."
        return 1
    fi
    return 0
}

# Check that staged Swift files compile
check_swift_build() {
    local swift_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.swift$' || true)

    if [ -n "$swift_files" ]; then
        echo "Running swift build..."
        if ! swift build 2>&1; then
            echo ""
            echo "ERROR: Commit blocked - swift build failed!"
            echo "Please fix compilation errors before committing."
            return 1
        fi
        echo "Swift build passed"
    fi
    return 0
}

# Main execution
main() {
    local checks_passed=true

    if ! check_aboutme_headers; then
        checks_passed=false
    fi

    if ! check_suspicious_files; then
        checks_passed=false
    fi

    if ! check_swift_build; then
        checks_passed=false
    fi

    if [ "$checks_passed" = false ]; then
        exit 1
    fi

    echo "All pre-commit checks passed"
    exit 0
}

main "$@"
