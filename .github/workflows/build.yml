name: Build

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Clone scenarios repo
        run: |
          git clone https://github.com/jfarcand/iphone-mirroir-scenarios.git .iphone-mirroir-mcp/scenarios

      - name: Build (debug)
        run: swift build

      - name: Build (release)
        run: swift build -c release

      - name: Unit tests
        run: swift test --skip IntegrationTests

      - name: Build and package FakeMirroring
        run: |
          swift build -c release --product FakeMirroring
          ./scripts/package-fake-app.sh

      - name: Launch FakeMirroring
        run: |
          open .build/release/FakeMirroring.app
          sleep 3

      - name: Integration tests (FakeMirroring)
        env:
          IPHONE_MIRROIR_BUNDLE_ID: com.jfarcand.FakeMirroring
          IPHONE_MIRROIR_PROCESS_NAME: FakeMirroring
        run: swift test --filter IntegrationTests

      - name: Test runner (FakeMirroring)
        env:
          IPHONE_MIRROIR_BUNDLE_ID: com.jfarcand.FakeMirroring
          IPHONE_MIRROIR_PROCESS_NAME: FakeMirroring
        run: |
          .build/release/iphone-mirroir-mcp test --junit test-results.xml --verbose Tests/Fixtures/scenarios/fake-mirroring-check.yaml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-runner-results
          path: |
            test-results.xml
            mirroir-test-results/

      - name: Binary info
        run: |
          ls -lh .build/release/iphone-mirroir-mcp .build/release/iphone-mirroir-helper
          file .build/release/iphone-mirroir-mcp
          file .build/release/iphone-mirroir-helper

      - name: Test MCP initialize
        run: |
          echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}' \
            | .build/release/iphone-mirroir-mcp 2>/dev/null \
            | python3 -c "
          import sys, json
          obj = json.loads(sys.stdin.readline())
          assert obj['result']['serverInfo']['name'] == 'iphone-mirroir-mcp'
          assert obj['result']['protocolVersion'] == '2025-11-25', f'Expected protocol version 2025-11-25, got: {obj[\"result\"][\"protocolVersion\"]}'
          print('MCP initialize: OK (protocol version 2025-11-25)')
          "

      - name: Test tools/list
        run: |
          printf '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}\n{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}\n' \
            | .build/release/iphone-mirroir-mcp --dangerously-skip-permissions 2>/dev/null \
            | python3 -c "
          import sys, json
          lines = sys.stdin.readlines()
          obj = json.loads(lines[1])
          tools = [t['name'] for t in obj['result']['tools']]
          expected = {'screenshot','start_recording','stop_recording','tap','swipe','drag','type_text','press_key','long_press','double_tap','shake','launch_app','open_url','press_home','press_app_switcher','spotlight','get_orientation','status','check_health','describe_screen','list_scenarios','get_scenario','scroll_to','reset_app','measure','set_network'}
          assert set(tools) == expected, f'Expected: {expected}\nGot: {set(tools)}\nMissing: {expected - set(tools)}\nExtra: {set(tools) - expected}'
          print(f'tools/list: {len(tools)} tools registered')
          "

      - name: Test tool schemas
        run: |
          printf '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}\n{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}\n' \
            | .build/release/iphone-mirroir-mcp --dangerously-skip-permissions 2>/dev/null \
            | python3 -c "
          import sys, json
          lines = sys.stdin.readlines()
          obj = json.loads(lines[1])
          tools = {t['name']: t for t in obj['result']['tools']}

          # tap requires x and y
          tap = tools['tap']['inputSchema']
          assert 'x' in tap['properties'], 'tap missing x'
          assert 'y' in tap['properties'], 'tap missing y'
          assert set(tap.get('required', [])) == {'x', 'y'}, 'tap should require x and y'

          # swipe requires from_x, from_y, to_x, to_y
          swipe = tools['swipe']['inputSchema']
          assert all(k in swipe['properties'] for k in ['from_x','from_y','to_x','to_y']), 'swipe missing coords'

          # type_text requires text
          tt = tools['type_text']['inputSchema']
          assert 'text' in tt['properties'], 'type_text missing text'

          # screenshot has no required params
          ss = tools['screenshot']['inputSchema']
          assert ss.get('required', []) == [] or 'properties' not in ss or len(ss['properties']) == 0

          print('Tool schemas: OK')
          "

      - name: Test fail-closed default (readonly only)
        run: |
          printf '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}\n{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}\n' \
            | .build/release/iphone-mirroir-mcp 2>/dev/null \
            | python3 -c "
          import sys, json
          lines = sys.stdin.readlines()
          obj = json.loads(lines[1])
          tools = [t['name'] for t in obj['result']['tools']]
          expected_readonly = {'screenshot','start_recording','stop_recording','get_orientation','status','check_health','describe_screen','list_scenarios','get_scenario'}
          assert set(tools) == expected_readonly, f'Fail-closed should show only readonly tools.\nExpected: {expected_readonly}\nGot: {set(tools)}\nExtra: {set(tools) - expected_readonly}\nMissing: {expected_readonly - set(tools)}'
          print(f'Fail-closed default: {len(tools)} readonly tools (OK)')
          "

      - name: Test --yolo alias shows all tools
        run: |
          printf '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}\n{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}\n' \
            | .build/release/iphone-mirroir-mcp --yolo 2>/dev/null \
            | python3 -c "
          import sys, json
          lines = sys.stdin.readlines()
          obj = json.loads(lines[1])
          tools = [t['name'] for t in obj['result']['tools']]
          assert len(tools) == 28, f'--yolo should show all 28 tools, got {len(tools)}: {tools}'
          print(f'--yolo alias: {len(tools)} tools (OK)')
          "

      - name: Test unknown method returns error
        run: |
          printf '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}\n{"jsonrpc":"2.0","id":2,"method":"nonexistent/method","params":{}}\n' \
            | .build/release/iphone-mirroir-mcp 2>/dev/null \
            | python3 -c "
          import sys, json
          lines = sys.stdin.readlines()
          resp = json.loads(lines[1])
          assert 'error' in resp, f'Expected error response, got: {resp}'
          assert resp['error']['code'] != 0, 'Error code should be non-zero'
          print(f'Unknown method error: code={resp[\"error\"][\"code\"]}')
          "

      - name: Test invalid JSON is handled
        run: |
          printf '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}\nthis is not json\n' \
            | .build/release/iphone-mirroir-mcp 2>/dev/null \
            | python3 -c "
          import sys, json
          lines = sys.stdin.readlines()
          # First line should be valid initialize response
          init_resp = json.loads(lines[0])
          assert 'result' in init_resp, 'Initialize should succeed'
          # Second line should be a parse error (-32700)
          if len(lines) > 1:
              err = json.loads(lines[1])
              assert 'error' in err, f'Expected error for bad JSON, got: {err}'
              print(f'Invalid JSON error: code={err[\"error\"][\"code\"]}')
          else:
              print('Server dropped invalid JSON (acceptable)')
          "

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: macos-15
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Build release binaries
        run: swift build -c release

      - name: Create release archive
        run: |
          cp Resources/com.jfarcand.iphone-mirroir-helper.plist .build/release/
          cd .build/release
          tar czf $GITHUB_WORKSPACE/iphone-mirroir-mcp-darwin-arm64.tar.gz iphone-mirroir-mcp iphone-mirroir-helper com.jfarcand.iphone-mirroir-helper.plist

      - name: Generate checksums
        run: shasum -a 256 iphone-mirroir-mcp-darwin-arm64.tar.gz > SHA256SUMS

      - name: Upload release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            iphone-mirroir-mcp-darwin-arm64.tar.gz
            SHA256SUMS
