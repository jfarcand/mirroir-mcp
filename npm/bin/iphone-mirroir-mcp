#!/usr/bin/env node
// Thin wrapper that launches the native MCP server binary.
// When called with "setup" argument, runs the interactive helper daemon installer.

const { execFileSync } = require("child_process");
const fs = require("fs");
const path = require("path");

const binDir = __dirname;
const pkgDir = path.dirname(binDir);
const binary = path.join(binDir, "iphone-mirroir-mcp-native");
const setupScript = path.join(pkgDir, "setup.js");

// Handle "setup" subcommand — interactive helper daemon installation
if (process.argv[2] === "setup") {
  if (!fs.existsSync(setupScript)) {
    console.error("Setup script not found. Run: npm rebuild iphone-mirroir-mcp");
    process.exit(1);
  }
  try {
    execFileSync("node", [setupScript], { stdio: "inherit" });
  } catch (e) {
    console.error("Setup failed. See https://github.com/jfarcand/iphone-mirroir-mcp for manual install.");
    process.exit(1);
  }
  process.exit(0);
}

// Run the MCP server — starts regardless of helper daemon state.
// If the helper isn't running, tools return helpful error messages
// telling the user to run: npx iphone-mirroir-mcp setup
try {
  execFileSync(binary, process.argv.slice(2), { stdio: "inherit" });
} catch (e) {
  if (e.status != null) process.exit(e.status);
  console.error("iphone-mirroir-mcp binary not found. Run: npm rebuild iphone-mirroir-mcp");
  process.exit(1);
}
