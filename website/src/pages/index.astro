---
import Layout from "../layouts/Layout.astro";
import { Code } from "astro:components";
import "../styles/global.css";

const curlCmd = '/bin/bash -c "$(curl -fsSL https://mirroir.dev/get-mirroir.sh)"';
const npxCmd = "npx -y mirroir-mcp install";
const brewCmd = "brew tap jfarcand/tap && brew install mirroir-mcp";

const permissionsCode = `{
  "allow": ["tap", "swipe", "type_text", "press_key", "launch_app"],
  "deny": [],
  "blockedApps": ["Wallet", "Banking"]
}`;

const scenarioExpo = `name: Expo Go Signup + Onboarding
app: Expo Go
description: >
  Sign up, handle error or success,
  then swipe through onboarding.

steps:
  - launch: "Expo Go"
  - wait_for: "LoginDemo"
  - tap: "LoginDemo"
  - tap: "Sign Up"
  - tap: "Email"
  - type: "\${TEST_EMAIL}"
  - tap: "Password"
  - type: "\${TEST_PASSWORD}"
  - tap: "Create Account"
  - condition:
      if_visible: "already exists"
      then:
        - tap: "Sign In Instead"
        - tap: "Email"
        - type: "\${TEST_EMAIL}"
        - tap: "Password"
        - type: "\${TEST_PASSWORD}"
        - tap: "Sign In"
      else:
        - wait_for: "Welcome"
  - assert_visible: "Welcome"
  - screenshot: "authenticated"
  - repeat:
      until_visible: "Get Started"
      max: 5
      steps:
        - swipe: "left"
        - screenshot: "onboarding"
  - tap: "Get Started"
  - assert_visible: "Dashboard"
  - screenshot: "complete"`;

const scenarioWaze = `name: Commute ETA Notification
app: Waze, Messages
description: Get ETA from Waze, text it via iMessage.

steps:
  - launch: "Waze"
  - wait_for: "Where to?"
  - tap: "Where to?"
  - tap: "\${DESTINATION:-Work}"
  - tap: "Go"
  - wait_for: "min"
  - remember: "Read the commute ETA."
  - press_home: true
  - launch: "Messages"
  - tap: "New Message"
  - tap: "To:"
  - type: "\${RECIPIENT}"
  - tap: "\${RECIPIENT}"
  - tap: "iMessage"
  - type: "On my way! ETA {eta}"
  - press_key: "return"
  - screenshot: "message_sent"`;

const scenarioSpotify = `name: Play a Song
target: spotify
app: Spotify (macOS)
description: Search for a song and play it.

steps:
  - switch_target: "spotify"
  - tap: "Search"
  - wait_for: "What do you want to listen to?"
  - type: "\${SONG:-Bohemian Rhapsody}"
  - wait_for: "\${SONG:-Bohemian Rhapsody}"
  - tap: "\${SONG:-Bohemian Rhapsody}"
  - assert_visible: "Playing"
  - screenshot: "now_playing"`;

const scenariosRepo = "jfarcand/mirroir-scenarios";
const scenariosBase = `https://github.com/${scenariosRepo}`;
const rawBase = `https://raw.githubusercontent.com/${scenariosRepo}/main`;

interface Scenario {
  name: string;
  description: string;
  app: string;
  path: string;
  category: string;
  url: string;
  rawUrl: string;
}

const ghHeaders: Record<string, string> = {
  Accept: "application/vnd.github.v3+json",
};
const ghToken = import.meta.env.GITHUB_TOKEN ?? process.env.GITHUB_TOKEN;
if (ghToken) {
  ghHeaders.Authorization = `Bearer ${ghToken}`;
}

let scenarios: Scenario[] = [];
try {
  const treeRes = await fetch(
    `https://api.github.com/repos/${scenariosRepo}/git/trees/main?recursive=1`,
    { headers: ghHeaders }
  );
  const tree = await treeRes.json();
  const yamlFiles = (tree.tree ?? []).filter(
    (f: { path: string }) => f.path.endsWith(".yaml") || f.path.endsWith(".yml")
  );

  // Extract a top-level YAML scalar value, handling both inline strings
  // and block scalars (> folded, | literal). For block scalars, collects
  // indented continuation lines and joins them into a single string.
  function yamlValue(content: string, key: string): string {
    const lineMatch = content.match(new RegExp(`^${key}:\\s*(.*)$`, "m"));
    if (!lineMatch) return "";
    const rest = lineMatch[1].trim();
    // Inline value (most common): "description: some text here"
    if (rest && rest !== ">" && rest !== "|") return rest;
    // Block scalar: collect indented continuation lines
    const lines = content.split("\n");
    const startIdx = lines.findIndex((l) => l.match(new RegExp(`^${key}:`)));
    if (startIdx < 0) return rest;
    const blockLines: string[] = [];
    for (let i = startIdx + 1; i < lines.length; i++) {
      if (/^\s+\S/.test(lines[i])) {
        blockLines.push(lines[i].trim());
      } else if (lines[i].trim() === "") {
        blockLines.push("");
      } else {
        break;
      }
    }
    // Take just the first paragraph for the description card
    const firstPara: string[] = [];
    for (const line of blockLines) {
      if (line === "") break;
      firstPara.push(line);
    }
    return firstPara.join(" ");
  }

  const fetches = yamlFiles.map(async (f: { path: string }) => {
    const res = await fetch(
      `https://api.github.com/repos/${scenariosRepo}/contents/${f.path}`,
      { headers: ghHeaders }
    );
    const data = await res.json();
    const content = atob(data.content.replace(/\n/g, ""));
    const parts = f.path.split("/");
    const category = parts.length > 1 ? parts.slice(0, -1).join("/") : "";
    return {
      name: yamlValue(content, "name") || f.path,
      description: yamlValue(content, "description"),
      app: yamlValue(content, "app"),
      path: f.path,
      category,
      url: `${scenariosBase}/blob/main/${f.path}`,
      rawUrl: `${rawBase}/${f.path}`,
    };
  });
  scenarios = await Promise.all(fetches);
} catch {
  // Build continues with empty list if GitHub API is unreachable
}

---

<Layout
  title="mirroir-mcp — Give your AI an iPhone"
  description="MCP server that controls a real iPhone through macOS iPhone Mirroring. Screenshot, tap, swipe, type — from any MCP client."
>
  <!-- Hero -->
  <header>
    <img src={`${import.meta.env.BASE_URL}mirroir-wordmark.svg`} alt="mirroir-mcp" class="logo" width="80" height="100" />
    <h1>mirroir-mcp</h1>
    <p class="tagline">
      Give your AI an iPhone.
    </p>
    <p class="subtitle">
      We built an MCP server to control iPhones through macOS iPhone Mirroring. Then we realized the same tools — screenshot, tap, swipe, type — work on any macOS window. Same security model. Same scenarios. Same AI.
    </p>
  </header>

  <!-- Demo Videos -->
  <section class="demo-section">
    <h2>See it in action</h2>
    <div class="carousel demo-carousel">
      <div class="carousel-track">
        <div class="carousel-slide demo-slide">
          <h3>Login Flow</h3>
          <video autoplay loop muted playsinline>
            <source src={`${import.meta.env.BASE_URL}video1-expo-login.mp4`} type="video/mp4" />
          </video>
        </div>
        <div class="carousel-slide demo-slide">
          <h3>Cross-App Workflow</h3>
          <video autoplay loop muted playsinline>
            <source src={`${import.meta.env.BASE_URL}video2-waze-slack.mp4`} type="video/mp4" />
          </video>
        </div>
      </div>
      <button class="carousel-prev" aria-label="Previous">&#8249;</button>
      <button class="carousel-next" aria-label="Next">&#8250;</button>
      <div class="carousel-dots"></div>
    </div>
    <div class="demo-lightbox" id="demo-lightbox">
      <video autoplay loop muted playsinline id="demo-lightbox-video"></video>
    </div>
    <script>
      const lightbox = document.getElementById("demo-lightbox")!;
      const lbVideo = document.getElementById("demo-lightbox-video")! as HTMLVideoElement;

      document.querySelectorAll(".demo-slide video").forEach((vid) => {
        vid.addEventListener("click", () => {
          const src = (vid as HTMLVideoElement).querySelector("source")!.src;
          lbVideo.innerHTML = "";
          const source = document.createElement("source");
          source.src = src;
          source.type = "video/mp4";
          lbVideo.appendChild(source);
          lbVideo.load();
          lbVideo.play();
          lightbox.classList.add("active");
        });
      });

      lightbox.addEventListener("click", (e) => {
        if (e.target === lightbox) {
          lightbox.classList.remove("active");
          lbVideo.pause();
        }
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && lightbox.classList.contains("active")) {
          lightbox.classList.remove("active");
          lbVideo.pause();
        }
      });
    </script>
  </section>

  <!-- Install -->
  <section>
    <h2>Install mirroir-mcp</h2>
    <div class="install-block">
      <code><span class="prompt">$</span> {curlCmd}</code>
      <button class="copy-btn" data-copy={curlCmd}>Copy</button>
    </div>
    <p class="install-hint">
      Paste that in a macOS Terminal. Clones the repo, builds from source, installs the DriverKit virtual HID, and starts the helper daemon.
    </p>
    <p class="alt-install">
      or via <a href="https://www.npmjs.com/package/mirroir-mcp">npx</a>:
    </p>
    <div class="install-block install-block-alt">
      <code><span class="prompt">$</span> {npxCmd}</code>
      <button class="copy-btn" data-copy={npxCmd}>Copy</button>
    </div>
    <p class="alt-install">
      or via <a href="https://tap.mirroir.dev">Homebrew</a>:
    </p>
    <div class="install-block install-block-alt">
      <code><span class="prompt">$</span> {brewCmd}</code>
      <button class="copy-btn" data-copy={brewCmd}>Copy</button>
    </div>
  </section>

  <!-- Scenarios -->
  <section>
    <h2>Scenarios: intents, not scripts</h2>
    <p>
      Scenarios are reusable YAML files that describe automation flows as intents, not scripts.
      Steps like <code>tap: "Email"</code> don't specify coordinates — the AI finds
      the element by OCR matching and adapts to unexpected dialogs and layout changes.
      Test an app or automate your morning routine. Share them on the <a href="https://github.com/jfarcand/mirroir-scenarios">community repository</a>.
    </p>

    <div class="carousel scenario-carousel">
      <div class="carousel-track">
        <div class="carousel-slide scenario-slide">
          <h3>Branching + looping</h3>
          <Code code={scenarioExpo} lang="yaml" theme="github-dark" />
        </div>
        <div class="carousel-slide scenario-slide">
          <h3>Cross-app workflow</h3>
          <Code code={scenarioWaze} lang="yaml" theme="github-dark" />
        </div>
        <div class="carousel-slide scenario-slide">
          <h3>macOS window</h3>
          <Code code={scenarioSpotify} lang="yaml" theme="github-dark" />
        </div>
      </div>
      <button class="carousel-prev" aria-label="Previous">&#8249;</button>
      <button class="carousel-next" aria-label="Next">&#8250;</button>
      <div class="carousel-dots"></div>
    </div>

    <p>
      <code>$&#123;VAR&#125;</code> placeholders resolve from environment variables.
      Install scenarios in Claude Code<sup>*</sup>:
    </p>
    <div class="install-block install-block-alt">
      <code><span class="prompt">$</span> claude plugin marketplace add marketplace.mirroir.dev</code>
      <button class="copy-btn" data-copy="claude plugin marketplace add marketplace.mirroir.dev">Copy</button>
    </div>
    <p class="install-hint">
      <sup>*</sup> Also supported by GitHub Copilot.
    </p>

    <h3 class="search-heading">Search the community scenario library</h3>
    <div class="scenario-search-wrap">
      <input
        type="text"
        id="scenario-q"
        placeholder="Search scenarios... (e.g. login, slack, calendar)"
        autocomplete="off"
      />
      <ul id="scenario-results"></ul>
    </div>
    <script id="scenario-data" type="application/json" set:html={JSON.stringify(scenarios)} />
    <script>
      const scenarios = JSON.parse(
        document.getElementById("scenario-data")!.textContent ?? "[]"
      );
      const input = document.getElementById("scenario-q")!;
      const results = document.getElementById("scenario-results")!;

      function render(matches: typeof scenarios) {
        if (!matches.length) {
          results.innerHTML = "";
          return;
        }
        results.innerHTML = matches
          .map(
            (s: any) =>
              `<li>
                <div class="scenario-row">
                  <a href="${s.url}" target="_blank">${s.name}</a>
                  <span class="scenario-app">${s.app}</span>
                  <a class="scenario-dl" href="${s.rawUrl}" download title="Download YAML">\u2193</a>
                </div>
                ${s.description ? `<span class="scenario-desc">${s.description}</span>` : ""}
              </li>`
          )
          .join("");
      }

      input.addEventListener("input", () => {
        const q = (input as HTMLInputElement).value.toLowerCase().trim();
        if (!q) {
          render([]);
          return;
        }
        const matches = scenarios.filter(
          (s: any) =>
            s.name.toLowerCase().includes(q) ||
            s.description.toLowerCase().includes(q) ||
            s.app.toLowerCase().includes(q) ||
            s.category.toLowerCase().includes(q)
        );
        render(matches);
      });
    </script>
  </section>

  <!-- Test Runner + Compiled Scenarios + Agent Diagnosis -->
  <section>
    <h2>Test, compile, diagnose</h2>
    <p>
      Run scenarios deterministically from the CLI &mdash; no AI in the loop. The AI auto-compiles on first execution, or use <code>mirroir compile</code> to cache coordinates for zero-OCR replay. When something breaks, <code>--agent</code> tells you why.
    </p>

    <div class="pipeline-grid">
      <div class="pipeline-step">
        <div class="pipeline-icon">1</div>
        <h3>Record</h3>
        <p>Interact with the phone while <code>mirroir record</code> captures your actions as a scenario YAML file.</p>
        <div class="pipeline-cmd">
          <code>mirroir record -o login.yaml</code>
        </div>
      </div>
      <div class="pipeline-step">
        <div class="pipeline-icon">2</div>
        <h3>Compile</h3>
        <p>The AI auto-compiles on first execution via MCP tools &mdash; or use <code>mirroir compile</code> from the CLI. Either way, coordinates, timing, and scroll counts are cached.</p>
        <div class="pipeline-cmd">
          <code>mirroir compile login</code>
        </div>
      </div>
      <div class="pipeline-step">
        <div class="pipeline-icon">3</div>
        <h3>Test</h3>
        <p>Replay with zero OCR — pure input injection. A 10-step scenario drops from 5+ seconds of OCR to under a second.</p>
        <div class="pipeline-cmd">
          <code>mirroir test login</code>
        </div>
      </div>
      <div class="pipeline-step">
        <div class="pipeline-icon">4</div>
        <h3>Diagnose</h3>
        <p>When a step fails, <code>--agent</code> compares expected vs. actual OCR and tells you the root cause and fix.</p>
        <div class="pipeline-cmd">
          <code>mirroir test --agent login</code>
        </div>
      </div>
    </div>

    <p>
      Agent diagnosis runs in two tiers: deterministic OCR analysis first (free, no API key), then optionally an AI model for richer analysis.
      Supports <a href="https://github.com/jfarcand/mirroir-mcp#agent-diagnosis">Anthropic, OpenAI, local Ollama, and CLI agents</a>.
    </p>
  </section>

  <!-- What it does -->
  <section>
    <h2>What Does mirroir-mcp Do?</h2>
    <p>28 tools exposed as an MCP server.</p>

    <div class="tool-grid">
      <div class="tool-category cat-touch">
        <h3>Touch</h3>
        <ul>
          <li><code>tap</code> <span>Tap at screen coordinates</span></li>
          <li><code>double_tap</code> <span>Double-tap for zoom or text selection</span></li>
          <li><code>long_press</code> <span>Hold for context menus</span></li>
          <li><code>swipe</code> <span>Quick flick between two points</span></li>
          <li><code>drag</code> <span>Slow drag for sliders and icons</span></li>
        </ul>
      </div>
      <div class="tool-category cat-input">
        <h3>Input</h3>
        <ul>
          <li><code>type_text</code> <span>Type text via virtual keyboard</span></li>
          <li><code>press_key</code> <span>Send special keys with modifiers</span></li>
          <li><code>shake</code> <span>Shake gesture for undo or dev menus</span></li>
        </ul>
      </div>
      <div class="tool-category cat-observe">
        <h3>Observe</h3>
        <ul>
          <li><code>screenshot</code> <span>Capture screen as PNG</span></li>
          <li><code>describe_screen</code> <span>OCR with tap coordinates</span></li>
          <li><code>start_recording</code> <span>Begin video recording</span></li>
          <li><code>stop_recording</code> <span>End recording, get file path</span></li>
          <li><code>get_orientation</code> <span>Portrait or landscape</span></li>
          <li><code>status</code> <span>Connection and device readiness</span></li>
          <li><code>check_health</code> <span>Full setup diagnostic</span></li>
        </ul>
      </div>
      <div class="tool-category cat-navigate">
        <h3>Navigate</h3>
        <ul>
          <li><code>launch_app</code> <span>Open app by name via Spotlight</span></li>
          <li><code>open_url</code> <span>Open URL in Safari</span></li>
          <li><code>press_home</code> <span>Return to home screen</span></li>
          <li><code>press_app_switcher</code> <span>Show recent apps</span></li>
          <li><code>spotlight</code> <span>Open Spotlight search</span></li>
          <li><code>scroll_to</code> <span>Scroll until element visible via OCR</span></li>
          <li><code>reset_app</code> <span>Force-quit app via App Switcher</span></li>
          <li><code>set_network</code> <span>Toggle airplane, Wi-Fi, cellular</span></li>
          <li><code>measure</code> <span>Time screen transitions</span></li>
          <li><code>list_scenarios</code> <span>List available scenarios</span></li>
          <li><code>get_scenario</code> <span>Read scenario with env substitution + compilation status</span></li>
          <li><code>record_step</code> <span>Record a compiled step during execution</span></li>
          <li><code>save_compiled</code> <span>Save compiled .json for zero-OCR replay</span></li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Integrations -->
  <section>
    <h2>Integrations</h2>
    <p>Any MCP client that supports stdio transport — plug into your editor or build your own agent.</p>

    <div class="client-group">
      <h3>Agents</h3>
      <div class="client-list">
        <a href="https://docs.anthropic.com/en/docs/claude-code"><span>Claude Code</span></a>
        <a href="https://chatgpt.com"><span>ChatGPT</span></a>
        <a href="https://cursor.com"><span>Cursor</span></a>
        <a href="https://github.com/features/copilot"><span>GitHub Copilot</span></a>
      </div>
    </div>

    <div class="client-group">
      <h3>Frameworks</h3>
      <div class="client-list">
        <a href="https://github.com/langchain-ai/langgraph"><span>LangGraph</span></a>
        <a href="https://strandsagents.com"><span>Strands Agents</span></a>
      </div>
    </div>
  </section>

  <!-- Permissions -->
  <section>
    <h2>Fail-closed by default</h2>
    <p>
      Without a config file, only read-only tools are exposed. Mutating tools are
      hidden from the MCP client entirely — it never sees them unless you allow them.
    </p>

    <Code code={permissionsCode} lang="json" theme="github-dark" />

    <p>
      Drop this in <code>~/.mirroir-mcp/permissions.json</code> to control
      exactly which tools your AI agent can use.
    </p>
  </section>

  <!-- FAQ -->
  <section>
    <h2>FAQ</h2>
    <div class="faq-list">
      <details>
        <summary>Is this safe? Can the AI access my banking apps?</summary>
        <p>Without a config file, only read-only tools are exposed. Mutating tools require explicit opt-in. Use <code>blockedApps</code> in <code>permissions.json</code> to deny access to sensitive apps. Closing iPhone Mirroring kills all input immediately.</p>
      </details>
      <details>
        <summary>Why does my cursor jump when the AI is working?</summary>
        <p>macOS routes HID input to the frontmost app. The server must activate iPhone Mirroring before each input. Put it in a separate macOS Space to keep your workspace undisturbed.</p>
      </details>
      <details>
        <summary>Does it work with any iPhone app?</summary>
        <p>Yes. It operates at the screen level through iPhone Mirroring — no source code, SDK, or jailbreak required. If you can see it on screen, the AI can interact with it.</p>
      </details>
      <details>
        <summary>Why does it need a DriverKit virtual HID?</summary>
        <p>iPhone Mirroring ignores programmatic <code>CGEvent</code> injection — it only responds to the system HID path. The installer uses the <a href="https://github.com/pqrs-org/Karabiner-DriverKit-VirtualHIDDevice">standalone Karabiner DriverKit package</a> (just the virtual HID, no keyboard grabber). Existing Karabiner-Elements installs are detected and reused.</p>
      </details>
      <details>
        <summary>Can it control macOS apps too, not just iPhone?</summary>
        <p>Yes. Add a target in <code>.mirroir-mcp/targets.json</code> pointing at any macOS window — Spotify, Figma, Terminal, anything. The same 28 tools work on any target. Use <code>switch_target</code> to move between iPhone and macOS windows.</p>
      </details>
      <details>
        <summary>Can I restrict which tools the AI can use?</summary>
        <p>Yes. Drop a <code>permissions.json</code> with <code>allow</code> and <code>deny</code> lists. Tools not in the allow list are hidden from the MCP client entirely.</p>
      </details>
    </div>
    <p>
      <a href="https://github.com/jfarcand/mirroir-mcp/blob/main/docs/faq.md">Read the full FAQ</a>
    </p>
  </section>

  <!-- Carousel initialization -->
  <script>
    document.querySelectorAll(".carousel").forEach((carousel) => {
      const track = carousel.querySelector(".carousel-track") as HTMLElement;
      const slides = Array.from(carousel.querySelectorAll(".carousel-slide")) as HTMLElement[];
      const prevBtn = carousel.querySelector(".carousel-prev") as HTMLButtonElement;
      const nextBtn = carousel.querySelector(".carousel-next") as HTMLButtonElement;
      const dotsContainer = carousel.querySelector(".carousel-dots")!;

      if (slides.length < 2) {
        prevBtn.style.display = "none";
        nextBtn.style.display = "none";
        dotsContainer.remove();
        return;
      }

      let currentIndex = 0;

      slides.forEach((_, i) => {
        const dot = document.createElement("button");
        dot.classList.add("carousel-dot");
        dot.setAttribute("aria-label", `Go to slide ${i + 1}`);
        if (i === 0) dot.classList.add("active");
        dot.addEventListener("click", () => goTo(i));
        dotsContainer.appendChild(dot);
      });

      function goTo(index: number) {
        currentIndex = Math.max(0, Math.min(index, slides.length - 1));
        track.scrollTo({
          left: slides[currentIndex].offsetLeft - track.offsetLeft,
          behavior: "smooth",
        });
        updateUI();
      }

      function updateUI() {
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === slides.length - 1;
        dotsContainer.querySelectorAll(".carousel-dot").forEach((dot, i) => {
          dot.classList.toggle("active", i === currentIndex);
        });
      }

      prevBtn.addEventListener("click", () => goTo(currentIndex - 1));
      nextBtn.addEventListener("click", () => goTo(currentIndex + 1));

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const index = slides.indexOf(entry.target as HTMLElement);
              if (index >= 0) {
                currentIndex = index;
                updateUI();
              }
            }
          });
        },
        { root: track, threshold: 0.6 }
      );
      slides.forEach((slide) => observer.observe(slide));

      updateUI();
    });
  </script>

  <!-- Footer -->
  <footer>
    <p>
      Why "mirroir"? It's the old French spelling of <em>miroir</em> (mirror) — a nod to the author's roots, not a typo.
    </p>
    <p>
      <a href="https://github.com/jfarcand/mirroir-mcp">GitHub</a> &middot;
      <a href="https://github.com/jfarcand/mirroir-mcp#readme">Docs</a> &middot;
      <a href="https://github.com/jfarcand/mirroir-mcp/discussions/1">Community</a> &middot;
      <a href="https://github.com/sponsors/jfarcand">Sponsor</a> &middot;
      Apache-2.0 &middot;
      macOS 15+
    </p>
  </footer>
</Layout>
